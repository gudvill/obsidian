**Балансировка нагрузки** - метод распределения сетевого трафика и задач между сетевыми устройствами. Балансировка применима к следующим устройствам: кластер, прокси-сервер, брандмауэр, коммутатор, система DPI, DNS-сервер, сетевой адаптер.

Все компоненты сервиса (Frontend, Backend, база данных) могут находиться на одном сервере. Рост числа пользователей и объёма трафика влечет за собой увеличение нагрузки на инфраструктуру сервиса. 
Если нагрузка растёт, сервер можно масштабировать:
- вертикальное масштабирование: увеличение мощности конфигурации сервера, добавление ресурсов в облачный сервер (CPU, объём памяти);
- горизонтальное масштабирование: увеличение количества серверов, заточенных под одну задачу. Появляется необходимость в новом элементе инфраструктуры - балансировщике нагрузки.
#### Балансировка нагрузки и проксирование
Обратные прокси-серверы и балансировщики работают как посредники в коммуникации между клиентами и серверами. Термины «балансировщик« и «прокси-сервер» часто используют как взаимозаменяемые. 

**Обратный прокси-сервер** принимает запрос от клиента, направляет его на сервер, который может его выполнить, и возвращает ответ. Развёртывание обратного прокси имеет смысл даже при наличии только одного веб-сервера или сервера приложений. Не все прокси-серверы - это балансировщики, но главная функция у многих - балансировка нагрузки. 

**Балансировщик нагрузки** распределяет входящие запросы клиентов между группой серверов, в каждом случае возвращая ответ от выбранного сервера соответствующему клиенту. Балансировщики используются, когда объём запросов слишком велик для эффективного выполнения одним сервером. Развёртывание нескольких серверов также устраняет проблему единой точки отказа.

Балансировщик гарантирует, что сервер не будет перегружен трафиком и данные будут эффективно перемещаться между компонентами кластера. Функции:
- отказоустойчивость (если один сервер откажет, балансировщик распределит трафик между остальными элементами инфраструктуры); 
- оптимальное использование ресурсов;
- плавное масштабирование инфраструктуры; 
- защита от DDoS-атак (её обеспечивает задержка ответа, когда фоновые серверы не видят клиента до подтверждения по TCP).

Примеры балансировщиков: [[Nginx]], Apache.
#### Балансировка на уровнях модели OSI
Open System Interconnection ([[OSI]]) - модель стека взаимодействия сетевых протоколов. По модели OSI сетевые устройства выстраиваются в отличные по функционалу уровни. 

Балансировка происходит на следующих уровнях:
1. **сетевой уровень**: задача балансировщика - нужно сделать так, чтобы за один конкретный IP-адрес сервера отвечали разные физические машины. Такая балансировка может осуществляться с помощью множества разнообразных способов:
	- DNS-балансировка - на одно доменное имя выделяется несколько IP-адресов;
	- построение NLB-кластера - серверы объединяются в кластер, состоящий из входных и вычислительных узлов;
	- по IP с использованием дополнительного маршрутизатора;
	- по территориальному признаку - размещение одинаковых сервисов с одинаковыми адресами в территориально различных регионах Интернета.
2. **транспортный уровень**: функции балансировщика - трекинг сетевой информации о протоколах и портах приложений, комбинирование данных с алгоритмами балансировки, подбор целевого сервера с наименьшим временем ответа. Клиент обращается к балансировщику, тот перенаправляет запрос одному из серверов, который и будет его обрабатывать.
3. **прикладной уровень**: балансировщик работает в режиме «умного прокси» - он анализирует клиентские запросы и перенаправляет их на разные серверы в зависимости от характера запрашиваемого контента. Примеры:
	- веб-сервер [[Nginx]] распределяет запросы между фронтендом и бэкендом;
	- pgpool - промежуточный слой между клиентом и сервером СУБД PostgreSQL, распределяет запросы серверам баз данных в зависимости от их содержания (на чтение, на запись и др.).
#### Методы балансировки
1. проверка доступности - балансировщик мониторит статусы серверов и перенаправляет соединения в случае падения одного из них. Параметры оценки состояния сервера:
	- ответы на проверяющие запросы, интервал настраивается в секундах;
	- время ожидания сети;
	- ожидаемые коды ответа для протоколов проверки HTTP/HTTPS;
	- порог успеха/неуспеха - количество отправленных подряд запросов, после которых сервер продолжает работу или приостанавливается.
2. настройка соединений - проходят по схеме "входящий запрос -> балансировщик -> сервер. Задаваемые настройки:
	- ограничение количества соединений;
	- таймаут соединения определяет время ожидания ответа;
	- таймаут неактивности - время, когда подключение считается активным, даже если данные не передаются;
	- TCP-таймаут - время ожидания передачи данных для инспекции по установленному соединению.
